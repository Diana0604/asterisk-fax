[manage_calls]
exten => sound_wait,1,Verbose(1, managing new call)
;get step from db
same => n,Set(STEP=${DB(WESTILLFAX/step)})
;send email step has been dialed
same => n,System(sendemail -f diana.vallverdu@gmail.com -t antsonstiltstheatre@gmail.com -m 'DIALED call to step: ${STEP}' -u 'INFO' -xu diana.vallverdu@gmail.com -xp fcnxcntclkxrrxvd -s smtp.gmail.com)
;set waiting time from database
;same => n,Set(WAIT_TIME=${DB(WESTILLFAX/call_length/${STEP})})
;wait time for call
;same => n,Wait(${WAIT_TIME})
;set step to next
;same => n,Set(DB(WESTILLFAX/step)=${MATH(${STEP}+1,i)})
;send email info that call has finished
same => n,System(sendemail -f diana.vallverdu@gmail.com -t antsonstiltstheatre@gmail.com -m 'FINISHED call to step: ${STEP}' -u 'INFO' -xu diana.vallverdu@gmail.com -xp fcnxcntclkxrrxvd -s smtp.gmail.com)
;hangup
same => n,Hangup()

exten => sound_play,1,Verbose(1, playing call from fax machine)
same => n,Playback(${ARG1})

;====================================================================================== NEW VERSION ==========================================================
;HEALTHCHECK COMS
[healthchecks]
exten => fax,1,Verbose(1, send first fax)
same => n,Set(DB(WESTILLFAX/call)=on)
same => n,SendFax(/fax/tifs/01_healthfax.tif)
same => n,Set(DB(WESTILLFAX/call)=off)
same => n,Hangup()


[from-internal-custom]
exten => 1989ok,1,Verbose(1, call 1989)
same => n,Set(DB(WESTILLFAX/call)=on)
same => n,Wait(12)  ;THIS LINE FOR CALL
;same => n,ReceiveFax(${FAXDEST}/${tempfax}.tif,d) ;THIS LINE FOR FAX
same => n,Set(DB(WESTILLFAX/call)=off)
same => n,Return()


exten => 1989,1,Answer()
same => n,GosubIf($[${DB(WESTILLFAX/step)} = 02]?1989ok,1)
same => n,Hangup()

;FROM LUCY AND PAUL

[healthchecks]
exten => fax,1,Verbose(1, send first fax)
same => n,Set(DB(WESTILLFAX/call)=on)
same => n,SendFax(/fax/tifs/01_healthfax.tif)
same => n,Set(DB(WESTILLFAX/call)=off)
same => n,Hangup()


[from-internal-custom]
exten => 1989ok,1,Verbose(1, call 1989)
same => n,Set(DB(WESTILLFAX/call)=on)
same => n,Wait(8)
same => n,Set(DB(WESTILLFAX/call)=off)
same => n,Wait(5)
same => n,Return()


exten => 1989,1,Answer()
same => n,GosubIf($[${DB(WESTILLFAX/step)} = 02]?1989ok,1)
same => n,Hangup()


[healthchecks]
exten => call,1,Verbose(1, send first fax)
same => n,Set(DB(WESTILLFAX/call)=on)
same => n,Wait(98)
same => n,Set(DB(WESTILLFAX/call)=off)
same => n,Wait(5)
same => n,Hangup()


[from-internal-custom]
exten => 123ok,1,Verbose(1, call 123)
same => n,Set(DB(WESTILLFAX/call)=on)
same=> n,Set(FAXDEST=/tmp)
same => n,Set(tempfax=${STRFTIME(,,%C%y%m%d%H%M)})
same => n,ReceiveFax(${FAXDEST}/${tempfax}.tif,d)
same => n,Set(DB(WESTILLFAX/call)=off)
same => n,Return()


exten => 123,1,Answer()
same => n,GosubIf($[${DB(WESTILLFAX/step)} = 04]?123ok,1)
same => n,Hangup()


[tbl]
exten => helloworld,1,Verbose(1, send first fax)
same => n,Set(DB(WESTILLFAX/call)=on)
same => n,SendFax(/fax/tifs/05_helloworld.tif)
same => n,Set(DB(WESTILLFAX/call)=off)
same => n,Hangup()


[from-internal-custom]
exten => 900ok,1,Verbose(1, call 900)
same => n,Set(DB(WESTILLFAX/call)=on)
same=> n,Set(FAXDEST=/tmp)
same => n,Set(tempfax=${STRFTIME(,,%C%y%m%d%H%M)})
same => n,ReceiveFax(${FAXDEST}/${tempfax}.tif,d)
same => n,Set(DB(WESTILLFAX/call)=off)
same => n,Return()


exten => 900,1,Answer()
same => n,GosubIf($[${DB(WESTILLFAX/step)} = 06]?900ok,1)
same => n,Hangup()


[tbl]
exten => intro,1,Verbose(1, send first fax)
same => n,Set(DB(WESTILLFAX/call)=on)
same => n,SendFax(/fax/tifs/07_census.tif)
same => n,Set(DB(WESTILLFAX/call)=off)
same => n,Hangup()


[from-internal-custom]
exten => 112ok,1,Verbose(1, call 112)
same => n,Set(DB(WESTILLFAX/call)=on)
same=>n,Set(FAXDEST=/tmp)
same => n,Set(tempfax=${STRFTIME(,,%C%y%m%d%H%M)})
same => n,ReceiveFax(${FAXDEST}/${tempfax}.tif,d)
same => n,Set(DB(WESTILLFAX/call)=off)
same => n,Return()


exten => 112,1,Answer()
same => n,GosubIf($[${DB(WESTILLFAX/step)} = 08]?112ok,1)
same => n,Hangup()


[tbl]
exten => robotfax1,1,Verbose(1, send first fax)
same => n,Set(DB(WESTILLFAX/call)=on)
same => n,SendFax(/fax/tifs/09_scrambledcomms1.tif)
same => n,Set(DB(WESTILLFAX/call)=off)
same => n,Hangup()


[tbl]
exten => robotfax2,1,Verbose(1, send first fax)
same => n,Set(DB(WESTILLFAX/call)=on)
same => n,SendFax(/fax/tifs/10_scrambledcomms2.tif)
same => n,Set(DB(WESTILLFAX/call)=off)
same => n,Hangup()


[tbl]
exten => robotfax3,1,Verbose(1, send first fax)
same => n,Set(DB(WESTILLFAX/call)=on)
same => n,SendFax(/fax/tifs/11_scrambledcomms3.tif)
same => n,Set(DB(WESTILLFAX/call)=off)
same => n,Hangup()


[tbl]
exten => robotfax4,1,Verbose(1, send first fax)
same => n,Set(DB(WESTILLFAX/call)=on)
same => n,SendFax(/fax/tifs/12_scrambledcomms4.tif)
same => n,Set(DB(WESTILLFAX/call)=off)
same => n,Hangup()


[tbl]
exten => robotfax5,1,Verbose(1, send first fax)
same => n,Set(DB(WESTILLFAX/call)=on)
same => n,SendFax(/fax/tifs/13_descramble.tif)
same => n,Set(DB(WESTILLFAX/call)=off)
same => n,Hangup()


[from-internal-custom]
exten => 2019ok,1,Verbose(1, call 2019)
same => n,Set(DB(WESTILLFAX/call)=on)
same => n,Wait(28)
same => n,Set(DB(WESTILLFAX/call)=off)
same => n,Wait(5)
same => n,Return()


exten => 2019,1,Answer()
same => n,GosubIf($[${DB(WESTILLFAX/step)} = 14]?2019ok,1)
same => n,Hangup()


; LUCY AND PAUL ARE ENDED

;AUXILIAR
[from-internal-custom]
exten => 461414614146141,1,Verbose(1,reset show)
same => n,Set(DB(WESTILLFAX/step)=00)
same => n,Hangup()

[from-internal-custom]
exten => 490014900149001,1,Verbose(1,reset show)
same => n,System(reboot)
same => n,Hangup()

;[from-internal-custom]
;exten => 124131241312413,1,Verbose(1,reset show)
;same => n,System(tmate -S /tmp/tmate.sock new-session -d)
;same => n,System(tmate -S /tmp/tmate.sock wait tmate-ready)

;TESTER
[tester]
;exten =>tester,1,SendFax(/fax/tifs/tester.tif)
exten => tester,1,SendFax(/fax/tifs/01_healthfax.tif)
same => n,Hangup()
