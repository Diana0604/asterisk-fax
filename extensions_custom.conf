[manage_calls]
exten => sound_wait,1,Verbose(1, managing new call)
;get step from db
same => n,Set(STEP=${DB(WESTILLFAX/step)})
;send email step has been dialed
same => n,System(sendemail -f diana.vallverdu@gmail.com -t diana.vallverdu@gmail.com -m 'DIALED call to step: ${STEP}' -u 'INFO' -xu diana.vallverdu@gmail.com -xp fcnxcntclkxrrxvd -s smtp.gmail.com)
;set waiting time from database
same => n,Set(WAIT_TIME=${DB(WESTILLFAX/call_length/${STEP})})
;wait time for call
same => n,Wait(${WAIT_TIME})
;set step to next
same => n,Set(DB(WESTILLFAX/step)=${MATH(${STEP}+1,i)})
;send email info that call has finished
same => n,System(sendemail -f diana.vallverdu@gmail.com -t diana.vallverdu@gmail.com -m 'FINISHED call to step: ${STEP}' -u 'INFO' -xu diana.vallverdu@gmail.com -xp fcnxcntclkxrrxvd -s smtp.gmail.com)
;hangup
same => n,Hangup()

exten => sound_play,1,Verbose(1, playing call from fax machine)
same => n,Playback(${ARG1})

;HEALTHCHECK COMS
[healthchecks]
exten => 00,1,Verbose(1, call zero)
same => n,Wait(5)
same => n,System(sendemail -f diana.valverdu@gmail.com -t diana.vallverdu@gmail.com -m 'STARTING healthcall #1 has been launched' -u 'INFO' -xu diana.vallverdu@gmail.com -xp fcnxcntclkxrrxvd -s smtp.gmail.com)
same => n,Background(faxmachine/press1)
same => n,Background(faxmachine/press1)
same => n,Background(faxmachine/press1)
same => n,System(sendemail -f diana.valverdu@gmail.com -t diana.vallverdu@gmail.com -m 'REPEATING healthcall #1 has finished without pressing 1' -u 'INFO' -xu diana.vallverdu@gmail.com -xp fcnxcntclkxrrxvd -s smtp.gmail.com)
same => n,Hangup()

exten => 1,1,Wait(2)
same => n,Set(DB(WESTILLFAX/step)=03)
same => n,Gosub(manage_calls,sound_play,1(faxmachine/01))
same => n,Hangup()

exten => i,1,Background(sorry)
same => n,Hangup()

[healthchecks]
exten => 01,1,System(sendemail -f diana.valverdu@gmail.com -t diana.vallverdu@gmail.com -m 'STARTING healthfax #1 has been launched' -u 'INFO' -xu diana.vallverdu@gmail.com -xp fcnxcntclkxrrxvd -s smtp.gmail.com)
same => n,SendFax(/fax/tifs/03_healthfax1.tif)
same => n,Set(DB(WESTILLFAX/step)=04)
same => n,System(sendemail -f diana.valverdu@gmail.com -t diana.vallverdu@gmail.com -m 'FINISHING healthfax #1 finished printing' -u 'INFO' -xu diana.vallverdu@gmail.com -xp fcnxcntclkxrrxvd -s smtp.gmail.com)
same => n,Hangup()

[from-internal-custom]
exten => 456,1,Verbose(1, healthline called received)
same => n,Set(DB(WESTILLFAX/step)=05)
#same =>n,Gosub(manage_calls,sound_wait,1)
#same => n,Playback(hello-world)
same => n,Hangup()

[from-internal-custom]
exten => 123,1,Verbose(1, sending fax)
same => n,Set(FAXDEST=/tmp)
same => n,Set(tempfax=${STRFTIME(,,%C%y%m%d%H%M)})
same => n,ReceiveFax(${FAXDEST}/${tempfax}.tif,d)
same => n,Set(DB(WESTILLFAX/step)=06)
same => n,Hangup()

;----------------------- TBL COMS PART 1 -------------------------------


;what we send
[tbl]
exten => helloworld,1,System(sendemail -f diana.valverdu@gmail.com -t diana.vallverdu@gmail.com -m 'STARTING hello world fax' -u 'INFO' -xu diana.vallverdu@gmail.com -xp fcnxcntclkxrrxvd -s smtp.gmail.com)
same => n,SendFax(/fax/tifs/05_helloworld.tif)
same => n,Set(DB(WESTILLFAX/step)=07)
same => n,System(sendemail -f diana.valverdu@gmail.com -t diana.vallverdu@gmail.com -m 'FINISHING hello world fax' -u 'INFO' -xu diana.vallverdu@gmail.com -xp fcnxcntclkxrrxvd -s smtp.gmail.com)
same => n,System(sendemail -f 'faxmachinX321@intergalactical-mail.univ' -t agent4.consignia.rm@gmail.com -m 'NEW TBL FAX' -u 'TBL FAX' -xu agent4.consignia.rm@gmail.com -a /fax/tifs/01-helloworld.tif -xp FAX.2020 -s smtp.gmail.com)
same => n,Hangup()

;Hellowolrd-send Declaration to 900
[from-internal-custom]
exten => 900,1,Verbose(1, receiving fax)
same => n,Set(FAXDEST=/tmp)
same => n,Set(tempfax=${STRFTIME(,,%C%y%m%d%H%M)})
same => n,ReceiveFax(${FAXDEST}/${tempfax}.tif,d)
same => n,Set(DB(WESTILLFAX/step)=08)
same => n,Hangup()

[tbl]
exten => notarobot,1,System(sendemail -f diana.valverdu@gmail.com -t diana.vallverdu@gmail.com -m 'STARTING trust ex 1 fax' -u 'INFO' -xu diana.vallverdu@gmail.com -xp fcnxcntclkxrrxvd -s smtp.gmail.com)
same => n,SendFax(/fax/tifs/08_notarobot.tif)
same => n,Set(DB(WESTILLFAX/step)=09)
same => n,System(sendemail -f diana.valverdu@gmail.com -t diana.vallverdu@gmail.com -m 'FINISHING trust ex 1 fax' -u 'INFO' -xu diana.vallverdu@gmail.com -xp fcnxcntclkxrrxvd -s smtp.gmail.com)
same => n,System(sendemail -f 'faxmachinX321@intergalactical-mail.univ' -t agent4.consignia.rm@gmail.com -m 'NEW TBL FAX' -u 'TBL FAX' -xu agent4.consignia.rm@gmail.com -a /fax/tifs/02-trust1.tif -xp FAX.2020 -s smtp.gmail.com)
same => n,Hangup()

[from-internal-custom]
exten => 2019,1,Answer()
same => n,Set(DB(WESTILLFAX/step)=10)
same =>n,Gosub(manage_calls,sound_wait,1)
same => n,Hangup()

[tbl]
exten => questionaire,1,System(sendemail -f diana.valverdu@gmail.com -t diana.vallverdu@gmail.com -m 'STARTING trust ex 3' -u 'INFO' -xu diana.vallverdu@gmail.com -xp fcnxcntclkxrrxvd -s smtp.gmail.com)
same => n,SendFax(/fax/tifs/10_questionnaire.tif)
same => n,Set(DB(WESTILLFAX/step)=11)
same => n,System(sendemail -f diana.valverdu@gmail.com -t diana.vallverdu@gmail.com -m 'FINISHING trust ex 3' -u 'INFO' -xu diana.vallverdu@gmail.com -xp fcnxcntclkxrrxvd -s smtp.gmail.com)
same => n,System(sendemail -f 'faxmachinX321@intergalactical-mail.univ' -t agent4.consignia.rm@gmail.com -m 'NEW TBL FAX' -u 'TBL FAX' -xu agent4.consignia.rm@gmail.com -a /fax/tifs/02-trust3.tif -xp FAX.2020 -s smtp.gmail.com)
same => n,Hangup()

;Questionnaire-Send Questionaire to 901
[from-internal-custom]
exten => 901,1,Verbose(1, receiving fax)
same => n,Set(FAXDEST=/tmp)
same => n,Set(tempfax=${STRFTIME(,,%C%y%m%d%H%M)})
same => n,ReceiveFax(${FAXDEST}/${tempfax}.tif,d)
same => n,Verbose(3, fax received)
same => n,Set(DB(WESTILLFAX/step)=12)
same => n,System(sendemail -f diana.vallverdu@gmail.com -t diana.vallverdu@gmail.com -m 'QUESTIONAIRE' -u 'ACTION' -xu diana.vallverdu@gmail.com -a ${FAXDEST}/${tempfax}.tif -xp fcnxcntclkxrrxvd -s smtp.gmail.com)
same => n,Hangup()

[tbl]
exten => openhatch,1,System(sendemail -f diana.valverdu@gmail.com -t diana.vallverdu@gmail.com -m 'STARTING antenna fax' -u 'INFO' -xu diana.vallverdu@gmail.com -xp fcnxcntclkxrrxvd -s smtp.gmail.com)
same => n,SendFax(/fax/tifs/12_openhatch.tif)
same => n,Set(DB(WESTILLFAX/step)=13)
same => n,System(sendemail -f diana.valverdu@gmail.com -t diana.vallverdu@gmail.com -m 'FINISHING antenna fax' -u 'INFO' -xu diana.vallverdu@gmail.com -xp fcnxcntclkxrrxvd -s smtp.gmail.com)
same => n,System(sendemail -f 'faxmachinX321@intergalactical-mail.univ' -t agent4.consignia.rm@gmail.com -m 'NEW TBL FAX' -u 'TBL FAX' -xu agent4.consignia.rm@gmail.com -a /fax/tifs/03-antenna.tif -xp FAX.2020 -s smtp.gmail.com)
same => n,Hangup()

[from-internal-custom]
exten => 555,1,Answer()
same => n,Set(DB(WESTILLFAX/step)=15)
same =>n,Gosub(manage_calls,sound_wait,1)
same => n,Hangup()

[tbl]
exten => mass,1,System(sendemail -f diana.valverdu@gmail.com -t diana.vallverdu@gmail.com -m 'STARTING step #3' -u 'INFO' -xu diana.vallverdu@gmail.com -xp fcnxcntclkxrrxvd -s smtp.gmail.com)
same => n,SendFax(/fax/tifs/16_mass.tif)
same => n,Set(DB(WESTILLFAX/step)=17)
same => n,System(sendemail -f diana.valverdu@gmail.com -t diana.vallverdu@gmail.com -m 'FINISHING step #3' -u 'INFO' -xu diana.vallverdu@gmail.com -xp fcnxcntclkxrrxvd -s smtp.gmail.com)
same => n,System(sendemail -f 'faxmachinX321@intergalactical-mail.univ' -t agent4.consignia.rm@gmail.com -m 'NEW TBL FAX' -u 'TBL FAX' -xu agent4.consignia.rm@gmail.com -a /fax/tifs/07-laststeps4.tif -xp FAX.2020 -s smtp.gmail.com)
same => n,Hangup()

;Mass-send Space Drawing to 902
[from-internal-custom]
exten => 902,1,Verbose(1, receiving fax)
same => n,Set(FAXDEST=/tmp)
same => n,Set(tempfax=${STRFTIME(,,%C%y%m%d%H%M)})
same => n,ReceiveFax(${FAXDEST}/${tempfax}.tif,d)
same => n,Verbose(3, fax received)
same => n,Set(DB(WESTILLFAX/step)=18)
same => n,System(sendemail -f diana.vallverdu@gmail.com -t diana.vallverdu@gmail.com -m 'SPACE DRAWING' -u 'ACTION' -xu diana.vallverdu@gmail.com -a ${FAXDEST}/${tempfax}.tif -xp fcnxcntclkxrrxvd -s smtp.gmail.com)
same => n,Hangup()

;LAST FAX
[ants]
exten => credits,1,System(sendemail -f diana.valverdu@gmail.com -t diana.vallverdu@gmail.com -m 'STARTING credits!' -u 'INFO' -xu diana.vallverdu@gmail.com -xp fcnxcntclkxrrxvd -s smtp.gmail.com)
same => n,SendFax(/fax/tifs/25_credits.tif)
same => n,Set(DB(WESTILLFAX/step)=26)
same => n,System(sendemail -f diana.valverdu@gmail.com -t diana.vallverdu@gmail.com -m 'FINISHING credits!' -u 'INFO' -xu diana.vallverdu@gmail.com -xp fcnxcntclkxrrxvd -s smtp.gmail.com)
same => n,Hangup()

[from-internal-custom]
exten => 1234,1,Answer()
    ;;Play mesage in English:
exten => 1234,n,agi(googletts.agi,"This is a simple google text to speech test in english.",en)
    ;;Play message in Spanish
exten => 1234,n,agi(googletts.agi,"Esta es una simple prueba en español.",es)
    ;;Play message in Greek
exten => 1234,n,agi(googletts.agi,"Αυτό είναι ένα απλό τέστ στα ελληνικά.",el)
exten => 1234,n,Hangup()

;TESTER
[tester]
exten =>tester,1,SendFax(/fax/tifs/tester.tif)
same => n,Set(DB(WESTILLFAX/step)=26)
same => n,Hangup()