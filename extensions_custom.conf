[manage_calls]
exten => sound_wait,1,Verbose(1, managing new call)
;get step from db
same => n,Set(STEP=${DB(WESTILLFAX/step)})
;send email step has been dialed
same => n,System(sendemail -f diana.vallverdu@gmail.com -t antsonstiltstheatre@gmail.com -m 'DIALED call to step: ${STEP}' -u 'INFO' -xu diana.vallverdu@gmail.com -xp fcnxcntclkxrrxvd -s smtp.gmail.com)
;set waiting time from database
;same => n,Set(WAIT_TIME=${DB(WESTILLFAX/call_length/${STEP})})
;wait time for call
;same => n,Wait(${WAIT_TIME})
;set step to next
;same => n,Set(DB(WESTILLFAX/step)=${MATH(${STEP}+1,i)})
;send email info that call has finished
same => n,System(sendemail -f diana.vallverdu@gmail.com -t antsonstiltstheatre@gmail.com -m 'FINISHED call to step: ${STEP}' -u 'INFO' -xu diana.vallverdu@gmail.com -xp fcnxcntclkxrrxvd -s smtp.gmail.com)
;hangup
same => n,Hangup()

exten => sound_play,1,Verbose(1, playing call from fax machine)
same => n,Playback(${ARG1})

;====================================================================================== NEW VERSION ==========================================================
;HEALTHCHECK COMS
[healthchecks]
exten => fax,1,Verbose(1, send first fax)
same => n,Set(DB(WESTILLFAX/call)=on)
same => n,SendFax(/fax/tifs/01_healthfax.tif)
same => n,Set(DB(WESTILLFAX/call)=off)
same => n,Hangup()


;[from-internal-custom]
;exten => 1989ok,1,Verbose(1, call 1989)
;same => n,Set(DB(WESTILLFAX/call)=on)
;same => n,Wait(12)  ;THIS LINE FOR CALL
;same => n,ReceiveFax(${FAXDEST}/${tempfax}.tif,d) ;THIS LINE FOR FAX
;same => n,Set(DB(WESTILLFAX/call)=off)
;same => n,Return()


;exten => 1989,1,Answer()
;same => n,GosubIf($[${DB(WESTILLFAX/step)} = 02]?1989ok,1)
;same => n,Hangup()

;FROM LUCY AND PAUL

[healthchecks]
exten => fax,1,Verbose(1, send first fax)
same => n,Set(DB(WESTILLFAX/call)=on)
same => n,SendFax(/fax/tifs/01_healthfax.tif)
same => n,Set(DB(WESTILLFAX/call)=off)
same => n,Hangup()


[from-internal-custom]
exten => 1989ok,1,Verbose(1, call 1989)
same => n,Set(DB(WESTILLFAX/call)=on)
same => n,Wait(8)
same => n,Set(DB(WESTILLFAX/call)=off)
same => n,Wait(5)
same => n,Return()


exten => 1989,1,Answer()
same => n,GosubIf($[${DB(WESTILLFAX/step)} = 02]?1989ok,1)
same => n,Hangup()


[healthchecks]
exten => call,1,Verbose(1, send first call)
same => n,Wait(5)
same => n,Background(sorry)
same => n,Background(sorry)
same => n,Background(sorry)
same => n,Background(sorry)
same => n,Background(sorry)
same => n,Background(sorry)
same => n,Background(sorry)
same => n,Background(sorry)
same => n,Background(sorry)
same => n,Background(sorry)
same => n,Background(sorry)
same => n,Background(sorry)
same => n,Background(sorry)
same => n,Background(sorry)
same => n,Background(sorry)
same => n,Background(sorry)
same => n,Background(sorry)
same => n,Background(sorry)
same => n,Background(sorry)
same => n,Background(sorry)
same => n,Hangup()

exten =>incall,1,Verbose(got to first all)
same => n,Set(DB(WESTILLFAX/call)=on)
same => n,Wait(98)
same => n,Set(DB(WESTILLFAX/call)=off)
same => n,Return()


exten => 1,1,Set(DB(WESTILLFAX/players)=01)
same => n,Gosub(incall, 1)

exten => 2,1,Set(DB(WESTILLFAX/players)=02)
same => n,Gosub(incall, 1)

exten => 3,1,Set(DB(WESTILLFAX/players)=03)
same => n,Gosub(incall, 1)

exten => 4,1,Set(DB(WESTILLFAX/players)=04)
same => n,Gosub(incall, 1)

exten => 5,1,Set(DB(WESTILLFAX/players)=05)
same => n,Gosub(incall, 1)

exten => 6,1,Set(DB(WESTILLFAX/players)=06)
same => n,Gosub(incall, 1)

exten => 7,1,Set(DB(WESTILLFAX/players)=07)
same => n,Gosub(incall, 1)

exten => 8,1,Set(DB(WESTILLFAX/players)=08)
same => n,Gosub(incall, 1)

exten => 9,1,Set(DB(WESTILLFAX/players)=09)
same => n,Gosub(incall, 1)

exten => 10,1,Set(DB(WESTILLFAX/players)=10)
same => n,Gosub(incall, 1)

exten => 11,1,Set(DB(WESTILLFAX/players)=11)
same => n,Gosub(incall, 1)

exten => 12,1,Set(DB(WESTILLFAX/players)=12)
same => n,Gosub(incall, 1)

exten => 13,1,Set(DB(WESTILLFAX/players)=13)
same => n,Gosub(incall, 1)

exten => 14,1,Set(DB(WESTILLFAX/players)=14)
same => n,Gosub(incall, 1)

exten => 15,1,Set(DB(WESTILLFAX/players)=15)
same => n,Gosub(incall, 1)

exten => 16,1,Set(DB(WESTILLFAX/players)=16)
same => n,Gosub(incall, 1)

exten => 17,1,Set(DB(WESTILLFAX/players)=17)
same => n,Gosub(incall, 1)

exten => 18,1,Set(DB(WESTILLFAX/players)=18)
same => n,Gosub(incall, 1)

exten => 19,1,Set(DB(WESTILLFAX/players)=19)
same => n,Gosub(incall, 1)

exten => 20,1,Set(DB(WESTILLFAX/players)=20)
same => n,Gosub(incall, 1)

 ;exten => i,1,Read(result,ivr-file-without-extension,max_digits);
 exten => i,1,Playback(invalid)
; exten => i,n,Verbose${EXTEN})


[from-internal-custom]
exten => 123ok,1,Verbose(1, call 123)
same => n,Set(DB(WESTILLFAX/call)=on)
same=> n,Set(FAXDEST=/tmp)
same => n,Set(tempfax=${STRFTIME(,,%C%y%m%d%H%M)})
same => n,ReceiveFax(${FAXDEST}/${tempfax}.tif,d)
same => n,Set(DB(WESTILLFAX/call)=off)
same => n,Return()


exten => 123,1,Answer()
same => n,GosubIf($[${DB(WESTILLFAX/step)} = 04]?123ok,1)
same => n,Hangup()


[tbl]
exten => helloworld,1,Verbose(1, send first fax)
same => n,Set(DB(WESTILLFAX/call)=on)
same => n,SendFax(/fax/tifs/05_helloworld.tif)
same => n,Set(DB(WESTILLFAX/call)=off)
same => n,Hangup()


[from-internal-custom]
exten => 900ok,1,Verbose(1, call 900)
same => n,Set(DB(WESTILLFAX/call)=on)
same=> n,Set(FAXDEST=/tmp)
same => n,Set(tempfax=${STRFTIME(,,%C%y%m%d%H%M)})
same => n,ReceiveFax(${FAXDEST}/${tempfax}.tif,d)
same => n,Set(DB(WESTILLFAX/call)=off)
same => n,Return()


exten => 900,1,Answer()
same => n,GosubIf($[${DB(WESTILLFAX/step)} = 06]?900ok,1)
same => n,Hangup()


[tbl]
exten => intro,1,Verbose(1, send first fax)
same => n,Set(DB(WESTILLFAX/call)=on)
same => n,SendFax(/fax/tifs/07_census.tif)
same => n,Set(DB(WESTILLFAX/call)=off)
same => n,Hangup()


[from-internal-custom]
exten => 112ok,1,Verbose(1, call 112)
same => n,Set(DB(WESTILLFAX/call)=on)
same=>n,Set(FAXDEST=/tmp)
same => n,Set(tempfax=${STRFTIME(,,%C%y%m%d%H%M)})
same => n,ReceiveFax(${FAXDEST}/${tempfax}.tif,d)
same => n,Set(DB(WESTILLFAX/call)=off)
same => n,Return()


exten => 112,1,Answer()
same => n,GosubIf($[${DB(WESTILLFAX/step)} = 08]?112ok,1)
same => n,Hangup()


[tbl]
exten => robotfax1,1,Verbose(1, send first fax)
same => n,Set(DB(WESTILLFAX/call)=on)
same => n,SendFax(/fax/tifs/09_scrambledcomms1.tif)
same => n,Set(DB(WESTILLFAX/call)=off)
same => n,Hangup()


[tbl]
exten => robotfax2,1,Verbose(1, send first fax)
same => n,Set(DB(WESTILLFAX/call)=on)
same => n,SendFax(/fax/tifs/10_scrambledcomms2.tif)
same => n,Set(DB(WESTILLFAX/call)=off)
same => n,Hangup()


[tbl]
exten => robotfax3,1,Verbose(1, send first fax)
same => n,Set(DB(WESTILLFAX/call)=on)
same => n,SendFax(/fax/tifs/11_scrambledcomms3.tif)
same => n,Set(DB(WESTILLFAX/call)=off)
same => n,Hangup()


[tbl]
exten => robotfax4,1,Verbose(1, send first fax)
same => n,Set(DB(WESTILLFAX/call)=on)
same => n,SendFax(/fax/tifs/12_scrambledcomms4.tif)
same => n,Set(DB(WESTILLFAX/call)=off)
same => n,Hangup()


[tbl]
exten => robotfax5,1,Verbose(1, send first fax)
same => n,Set(DB(WESTILLFAX/call)=on)
same => n,SendFax(/fax/tifs/13_descramble.tif)
same => n,Set(DB(WESTILLFAX/call)=off)
same => n,Hangup()


[from-internal-custom]
exten => 2019ok,1,Verbose(1, call 2019)
same => n,Set(DB(WESTILLFAX/call)=on)
same => n,Wait(28)
same => n,Set(DB(WESTILLFAX/call)=off)
same => n,Wait(5)
same => n,Return()


exten => 2019,1,Answer()
same => n,GosubIf($[${DB(WESTILLFAX/step)} = 14]?2019ok,1)
same => n,Hangup()


; LUCY AND PAUL ARE ENDED

;AUXILIAR
[from-internal-custom]
exten => 461414614146141,1,Verbose(1,reset show)
same => n,Set(DB(WESTILLFAX/step)=00)
same => n,Hangup()

[from-internal-custom]
exten => 490014900149001,1,Verbose(1,reset show)
same => n,System(reboot)
same => n,Hangup()

;[from-internal-custom]
;exten => 124131241312413,1,Verbose(1,reset show)
;same => n,System(tmate -S /tmp/tmate.sock new-session -d)
;same => n,System(tmate -S /tmp/tmate.sock wait tmate-ready)

;TESTER
[tester]
;exten =>tester,1,SendFax(/fax/tifs/tester.tif)
exten => tester,1,SendFax(/fax/tifs/01_healthfax.tif)
same => n,Hangup()
